import{SvelteComponent as me,append as s,attr as a,binding_callbacks as Q,check_outros as z,create_component as ee,destroy_component as te,destroy_each as pe,detach as V,element as c,group_outros as se,init as fe,insert as X,listen as J,mount_component as ne,run_all as de,safe_not_equal as ge,set_data as ae,set_input_value as le,set_style as Z,space as P,text as Y,to_number as oe,transition_in as G,transition_out as K}from"../../web_modules/svelte/internal.js";import{onMount as he}from"../../web_modules/svelte.js";import xe from"./RAM.js";import be from"./Register.js";import L from"../utils/tohex.js";import Ce from"../6502/disassembler/index.js";import ve from"../cartridge/index.js";import we from"../bus/index.js";import $e from"../6502/index.js";import ke from"../ppu/index.js";function ie(n,i,t){const e=n.slice();return e[33]=i[t],e}function ce(n){let i,t,e,o,h,m,C,D,p,f,q,v,w,$,d,E,j,T,_,F,H,A,R=L(n[8],{withPrefix:!0,length:4})+"",N,U,I,S,W,u,b,M,B=n[12],k=[];for(let r=0;r<B.length;r+=1)k[r]=re(ie(n,B,r));S=new be({props:{registers:n[9]}});let g=n[0].cartridge&&n[6]&&ue(n);return{c(){i=c("div"),t=c("div"),t.textContent="Debug",e=P(),o=c("div"),h=c("div"),m=c("div"),C=c("label"),C.textContent="Palette",D=P(),p=c("div"),f=c("input"),q=P(),v=c("div");for(let r=0;r<k.length;r+=1)k[r].c();w=P(),$=c("div"),d=c("canvas"),E=P(),j=c("canvas"),T=P(),_=c("div"),F=c("div"),H=Y("PC: "),A=c("span"),N=Y(R),U=P(),I=c("div"),ee(S.$$.fragment),W=P(),g&&g.c(),a(t,"class","text-xl text-center"),a(C,"for","palettenumber"),a(C,"class","col-sm-2 col-form-label"),a(f,"name","palettenumber"),a(f,"class","text-black form-control"),a(f,"type","number"),a(f,"min","0"),a(f,"max","7"),a(p,"class","col-sm-8"),a(v,"class","col-sm-2 flex"),a(m,"class","form-group row"),a(d,"class","m-auto border-2 border-blue-400"),Z(d,"width","256px"),a(d,"width","128"),a(d,"height","128"),a(j,"class","ml-2 m-auto border-2 border-blue-400"),Z(j,"width","256px"),a(j,"width","128"),a(j,"height","128"),a($,"class","flex mt-4"),a(o,"class","mt-4"),a(A,"class","font-mono"),a(_,"class","ml-4 flex-1 flex flex-col"),a(i,"class","ml-4")},m(r,l){X(r,i,l),s(i,t),s(i,e),s(i,o),s(o,h),s(h,m),s(m,C),s(m,D),s(m,p),s(p,f),le(f,n[10]),s(m,q),s(m,v);for(let y=0;y<k.length;y+=1)k[y].m(v,null);s(o,w),s(o,$),s($,d),n[23](d),s($,E),s($,j),n[24](j),s(i,T),s(i,_),s(_,F),s(F,H),s(F,A),s(A,N),s(_,U),s(_,I),ne(S,I,null),s(_,W),g&&g.m(_,null),u=!0,b||(M=J(f,"input",n[22]),b=!0)},p(r,l){if(l[0]&1024&&oe(f.value)!==r[10]&&le(f,r[10]),l[0]&4096){B=r[12];let x;for(x=0;x<B.length;x+=1){const O=ie(r,B,x);k[x]?k[x].p(O,l):(k[x]=re(O),k[x].c(),k[x].m(v,null))}for(;x<k.length;x+=1)k[x].d(1);k.length=B.length}(!u||l[0]&256)&&R!==(R=L(r[8],{withPrefix:!0,length:4})+"")&&ae(N,R);const y={};l[0]&512&&(y.registers=r[9]),S.$set(y),r[0].cartridge&&r[6]?g?(g.p(r,l),l[0]&65&&G(g,1)):(g=ue(r),g.c(),G(g,1),g.m(_,null)):g&&(se(),K(g,1,1,()=>{g=null}),z())},i(r){if(u)return;G(S.$$.fragment,r),G(g),u=!0},o(r){K(S.$$.fragment,r),K(g),u=!1},d(r){r&&V(i),pe(k,r),n[23](null),n[24](null),te(S),g&&g.d(),b=!1,M()}}}function re(n){let i,t;return{c(){i=c("div"),a(i,"class","flex-1"),a(i,"style",t=`background-color: ${n[33]}`)},m(e,o){X(e,i,o)},p(e,o){o[0]&4096&&t!==(t=`background-color: ${e[33]}`)&&a(i,"style",t)},d(e){e&&V(i)}}}function ue(n){let i,t,e;return t=new xe({props:{ram:n[11],offsetStart:n[7],length:16,pc:n[8]}}),t.$on("change",n[18]),{c(){i=c("div"),ee(t.$$.fragment),a(i,"class","mt-4")},m(o,h){X(o,i,h),ne(t,i,null),e=!0},p(o,h){const m={};h[0]&2048&&(m.ram=o[11]),h[0]&128&&(m.offsetStart=o[7]),h[0]&256&&(m.pc=o[8]),t.$set(m)},i(o){if(e)return;G(t.$$.fragment,o),e=!0},o(o){K(t.$$.fragment,o),e=!1},d(o){o&&V(i),te(t)}}}function ye(n){let i,t,e,o,h,m,C,D,p,f,q,v,w,$,d,E,j,T,_,F,H,A,R=(n[5]?"Pause":"Run")+"",N,U,I,S,W,u=n[6]&&ce(n);return{c(){i=c("div"),t=c("div"),e=c("div"),o=c("canvas"),h=P(),m=c("div"),C=c("canvas"),D=P(),p=c("div"),f=c("input"),q=P(),v=c("label"),w=c("input"),$=Y(`
        Show Debug Tools`),d=P(),E=c("button"),E.textContent="Reset",j=P(),T=c("button"),T.textContent="Execute Code Step-by-Step",_=P(),F=c("button"),F.textContent="Execute Code for Whole Frame",H=P(),A=c("button"),N=Y(R),U=P(),u&&u.c(),a(o,"class","hidden"),a(o,"width","256"),a(o,"height","240"),a(C,"width","512"),a(C,"height","480"),a(m,"class","m-auto border-2 border-blue-400"),Z(m,"width","512px"),a(f,"type","file"),a(f,"accept",".nes"),a(w,"type","checkbox"),a(v,"class","mt-2"),a(E,"class","mt-2"),a(T,"class","mt-2"),a(F,"class","mt-2"),a(A,"class","mt-2"),a(p,"class","flex flex-column ml-4"),a(t,"class","flex flex-2"),a(i,"class","flex m-auto p-10")},m(b,M){X(b,i,M),s(i,t),s(t,e),s(e,o),n[19](o),s(e,h),s(e,m),s(m,C),n[20](C),s(t,D),s(t,p),s(p,f),s(p,q),s(p,v),s(v,w),w.checked=n[6],s(v,$),s(p,d),s(p,E),s(p,j),s(p,T),s(p,_),s(p,F),s(p,H),s(p,A),s(A,N),s(i,U),u&&u.m(i,null),I=!0,S||(W=[J(f,"change",n[14]),J(w,"change",n[21]),J(E,"click",n[15]),J(T,"click",n[16]),J(F,"click",n[17]),J(A,"click",n[13])],S=!0)},p(b,M){M[0]&64&&(w.checked=b[6]),(!I||M[0]&32)&&R!==(R=(b[5]?"Pause":"Run")+"")&&ae(N,R),b[6]?u?(u.p(b,M),M[0]&64&&G(u,1)):(u=ce(b),u.c(),G(u,1),u.m(i,null)):u&&(se(),K(u,1,1,()=>{u=null}),z())},i(b){if(I)return;G(u),I=!0},o(b){K(u),I=!1},d(b){b&&V(i),n[19](null),n[20](null),u&&u.d(),S=!1,de(W)}}}function Pe(n,i,t){let e,o,h,m,C,D=!1,p,f,q=!1,v=32768,w=32768,$,d=0,E=new Uint8Array(1024),j;e=new we(new $e(),new ke(),R);function T(){t(5,D=!D)}function _(){t(11,j=Ce(e.getRAMSnapshot(),{binaryStart:0}))}async function F(l){const y=l.target.files[0],x=new ve();await x.parse(y),t(0,e.cartridge=x,e),e.insertCartridge(x),e.reset(),t(7,v=e.cpu.PC),t(8,w=e.cpu.PC),t(9,$=e.cpu),_(),t(5,D=!0)}function H(){e.reset(),t(7,v=e.cpu.PC),t(8,w=e.cpu.PC),t(9,$=e.cpu)}function A(){do e.clock();while(!e.cpu.isComplete);do e.clock();while(e.cpu.isComplete);t(8,w=e.cpu.PC),t(9,$=e.cpu),R(e.ppu.getScreen().imageData)}function R(l){const y=h.getContext("2d");p.putImageData(l,0,0),y.drawImage(o,0,0,256,240,0,0,512,480),q&&(S(),N())}function N(){E=e.ppu.tableName[0]}function U(){do e.clock();while(!e.ppu.isFrameComplete);do e.clock();while(e.cpu.isComplete);t(0,e.ppu.isFrameComplete=!1,e),t(8,w=e.cpu.PC),t(9,$=e.cpu)}function I(l){if(D){if(f||(f=l),l-f>=1e3/60){f=l;do e.clock();while(!e.ppu.isFrameComplete);t(0,e.ppu.isFrameComplete=!1,e),t(8,w=e.cpu.PC),t(9,$=e.cpu)}requestAnimationFrame(I)}}function S(){const l=m.getContext("2d"),y=C.getContext("2d");l.putImageData(e.ppu.getPatternTable(0,d).imageData,0,0),y.putImageData(e.ppu.getPatternTable(1,d).imageData,0,0)}function W({detail:{value:l}}){t(7,v=l.offsetStart)}he(()=>{p=o.getContext("2d");const l=h.getContext("2d")});function u(l){Q[l?"unshift":"push"](()=>{o=l,t(1,o)})}function b(l){Q[l?"unshift":"push"](()=>{h=l,t(2,h)})}function M(){q=this.checked,t(6,q)}function B(){d=oe(this.value),t(10,d)}function k(l){Q[l?"unshift":"push"](()=>{m=l,t(3,m)})}function g(l){Q[l?"unshift":"push"](()=>{C=l,t(4,C)})}let r;return n.$$.update=()=>{if(n.$$.dirty[0]&32){e:D&&requestAnimationFrame(I)}if(n.$$.dirty[0]&1024){e:d>7?t(10,d=d%7):d<0&&t(10,d=7)}if(n.$$.dirty[0]&1025){e:t(12,r=(()=>{if(!e.cartridge)return[];const l=({r:y,g:x,b:O})=>`#${L(y)}${L(x)}${L(O)}`;return[...Array(8).keys()].map(y=>l(e.ppu.getColorFromPaletteRAM(d,y)))})())}},[e,o,h,m,C,D,q,v,w,$,d,j,r,T,F,H,A,U,W,u,b,M,B,k,g]}class _e extends me{constructor(n){super();fe(this,n,Pe,ye,ge,{},[-1,-1])}}export default _e;
