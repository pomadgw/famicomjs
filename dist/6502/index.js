function o(a,t){if(!(a instanceof t))throw new TypeError("Cannot call a class as a function")}function n(a,t){for(var i=0;i<t.length;i++){var e=t[i];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(a,e.key,e)}}function r(a,t,i){return t&&n(a.prototype,t),i&&n(a,i),a}import c from"./register.js";import{Flags as s}from"./flags.js";import d from"./opcodes.js";var l=function(){function a(){o(this,a),this.bus=null,this.A=0,this.X=0,this.Y=0,this.SP=253,this.PC=0,this.fetchedData=0,this.STATUS=new c(36),this.isImplicitInvoked=!1,this.opcode=0,this.debugCurrentOpsPC=0,this.debugCycles=0,this.reset(),this.absoluteAddress=0,this.relativeAddress=0,this.clocks=0,this.debugCurrentOps=[]}return r(a,[{key:"connect",value:function(t){this.bus=t}},{key:"reset",value:function(){this.A=0,this.X=0,this.Y=0,this.SP=253,this.fetchedData=0,this.STATUS=new c(36),this.isImplicitInvoked=!1,this.opcode=0;var t=65532,i=this.read(t),e=this.read(t+1);this.PC=e<<8|i,this.debugCurrentOpsPC=this.PC,this.absoluteAddress=0,this.relativeAddress=0,this.fetchedData=0,this.clocks=8}},{key:"read",value:function(t){var i=this.bus;return i?i.cpuRead(t):0}},{key:"write",value:function(t,i){var e=this.bus;if(!e)return;e.cpuWrite(t,i)}},{key:"nextPC",value:function(){return this.PC++}},{key:"clock",value:function(){if(this.debugCycles+=1,this.clocks===0){this.debugCurrentOpsPC=this.PC;var t=this.read(this.nextPC());this.opcode=t,this.debugCurrentOps=[t,this.read(this.PC+0),this.read(this.PC+1)],d(this,t),this.isImplicitInvoked=!1}this.clocks-=1}},{key:"fetch",value:function(){this.isImplicitInvoked||(this.fetchedData=this.read(this.absoluteAddress))}},{key:"pushStack",value:function(t){this.write(this.SP+256,t),this.SP--,this.SP&=255}},{key:"popStack",value:function(){this.SP++,this.SP&=255;var t=this.read(this.SP+256);return t}},{key:"interrupt",value:function(t){var i=this.PC;this.pushStack(i>>8&255),this.pushStack(i&255),this.STATUS.setStatus(s.B,!1),this.STATUS.setStatus(s.U,!0),this.STATUS.setStatus(s.I,!0),this.pushStack(this.STATUS.status),this.absoluteAddress=t;var e=this.read(t),h=this.read(t+1);this.PC=h<<8|e,this.clocks=7}},{key:"irq",value:function(){this.STATUS.getStatus(s.I)&&this.interrupt(65534)}},{key:"nmi",value:function(){this.interrupt(65530)}},{key:"absMode",value:function(){var t=this.read(this.nextPC()),i=this.read(this.nextPC()),e=i<<8|t;this.absoluteAddress=e,this.clocks+=0}},{key:"abxMode",value:function(){var t=this.read(this.nextPC()),i=this.read(this.nextPC()),e=this.X,h=(i<<8|t)+e;this.absoluteAddress=h&65535,this.clocks+=(h&65280)!==i<<8?1:0}},{key:"abyMode",value:function(){var t=this.read(this.nextPC()),i=this.read(this.nextPC()),e=this.Y,h=(i<<8|t)+e;this.absoluteAddress=h&65535,this.clocks+=(h&65280)!==i<<8?1:0}},{key:"immMode",value:function(){this.absoluteAddress=this.nextPC()}},{key:"impMode",value:function(){this.fetchedData=this.A,this.isImplicitInvoked=!0}},{key:"zp0Mode",value:function(){var t=this.read(this.nextPC());this.absoluteAddress=t}},{key:"zpxMode",value:function(){var t=this.read(this.nextPC());this.absoluteAddress=t+this.X&255}},{key:"zpyMode",value:function(){var t=this.read(this.nextPC());this.absoluteAddress=t+this.Y&255}},{key:"relMode",value:function(){var t=this.read(this.nextPC());t>127&&(t-=256),this.relativeAddress=t}},{key:"indMode",value:function(){var t=this.read(this.nextPC()),i=this.read(this.nextPC()),e=i<<8|t,h=this.read(e),u=t===255?e&65280:e+1,S=this.read(u);this.absoluteAddress=S<<8|h}},{key:"izxMode",value:function(){var t=this.read(this.nextPC()),i=this.read(t+this.X&255),e=this.read(t+this.X+1&255);this.absoluteAddress=e<<8|i}},{key:"izyMode",value:function(){var t=this.read(this.nextPC()),i=this.read(t&255),e=this.read(t+1&255);this.absoluteAddress=(e<<8|i)+this.Y&65535,this.clocks+=(this.absoluteAddress&65280)!==e<<8?1:0}},{key:"XXX",value:function(){}},{key:"CLC",value:function(){this.STATUS.setStatus(s.C,!1)}},{key:"CLD",value:function(){this.STATUS.setStatus(s.D,!1)}},{key:"CLI",value:function(){this.STATUS.setStatus(s.I,!1)}},{key:"CLV",value:function(){this.STATUS.setStatus(s.V,!1)}},{key:"SEC",value:function(){this.STATUS.setStatus(s.C,!0)}},{key:"SED",value:function(){this.STATUS.setStatus(s.D,!0)}},{key:"SEI",value:function(){this.STATUS.setStatus(s.I,!0)}},{key:"setZN",value:function(t){this.STATUS.setStatus(s.N,t>=128),this.STATUS.setStatus(s.Z,t===0)}},{key:"LDA",value:function(){this.fetch();var t=this.fetchedData;this.A=this.fetchedData,this.setZN(t),this.clocks+=0}},{key:"LDX",value:function(){this.fetch();var t=this.fetchedData;this.X=this.fetchedData,this.setZN(t),this.clocks+=0}},{key:"LDY",value:function(){this.fetch();var t=this.fetchedData;this.Y=this.fetchedData,this.setZN(t),this.clocks+=0}},{key:"STA",value:function(){this.write(this.absoluteAddress,this.A)}},{key:"STX",value:function(){this.write(this.absoluteAddress,this.X)}},{key:"STY",value:function(){this.write(this.absoluteAddress,this.Y)}},{key:"ADC",value:function(){this.fetch();var t=this.STATUS.getStatus(s.C)?1:0,i=this.A+this.fetchedData+t;this.STATUS.setStatus(s.C,i>255);var e=i&255;this.setZN(e);var h=(~(this.A^this.fetchedData)&(this.A^e)&128)>0;this.STATUS.setStatus(s.V,h),this.A=e,this.clocks+=1}},{key:"SBC",value:function(){this.fetch();var t=(this.fetchedData^255)&255,i=this.STATUS.getStatus(s.C)?1:0,e=this.A+t+i;this.STATUS.setStatus(s.C,e>255);var h=e&255;this.setZN(h);var u=(~(this.A^t)&(this.A^e)&128)>0;this.STATUS.setStatus(s.V,u),this.A=h,this.clocks+=1}},{key:"INC",value:function(){this.fetch();var t=this.fetchedData+1&255;this.write(this.absoluteAddress,t),this.setZN(t)}},{key:"INX",value:function(){var t=this.X+1&255;this.X=t,this.setZN(t)}},{key:"INY",value:function(){var t=this.Y+1&255;this.Y=t,this.setZN(t)}},{key:"DEC",value:function(){this.fetch();var t=this.fetchedData-1&255;this.write(this.absoluteAddress,t),this.setZN(t)}},{key:"DEX",value:function(){var t=this.X-1&255;this.X=t,this.setZN(t)}},{key:"DEY",value:function(){var t=this.Y-1&255;this.Y=t,this.setZN(t)}},{key:"JMP",value:function(){this.PC=this.absoluteAddress}},{key:"JSR",value:function(){var t=this.PC-1;this.pushStack(t>>8&255),this.pushStack(t&255),this.JMP()}},{key:"RTS",value:function(){var t=this.popStack();t|=this.popStack()<<8,this.PC=t+1}},{key:"jumpIfTrue",value:function(t){t&&(this.clocks+=1,this.absoluteAddress=this.relativeAddress+this.PC,(this.absoluteAddress&65280)!==(this.PC&65280)&&(this.clocks+=1),this.PC=this.absoluteAddress)}},{key:"BCC",value:function(){this.jumpIfTrue(!this.STATUS.getStatus(s.C))}},{key:"BCS",value:function(){this.jumpIfTrue(this.STATUS.getStatus(s.C))}},{key:"BEQ",value:function(){this.jumpIfTrue(this.STATUS.getStatus(s.Z))}},{key:"BNE",value:function(){this.jumpIfTrue(!this.STATUS.getStatus(s.Z))}},{key:"BMI",value:function(){this.jumpIfTrue(this.STATUS.getStatus(s.N))}},{key:"BPL",value:function(){this.jumpIfTrue(!this.STATUS.getStatus(s.N))}},{key:"BVS",value:function(){this.jumpIfTrue(this.STATUS.getStatus(s.V))}},{key:"BVC",value:function(){this.jumpIfTrue(!this.STATUS.getStatus(s.V))}},{key:"AND",value:function(){this.fetch();var t=this.A&this.fetchedData;this.A=t,this.setZN(t),this.clocks+=1}},{key:"ORA",value:function(){this.fetch();var t=this.A|this.fetchedData;this.A=t,this.setZN(t),this.clocks+=1}},{key:"EOR",value:function(){this.fetch();var t=this.A^this.fetchedData;this.A=t,this.setZN(t),this.clocks+=1}},{key:"ASL",value:function(){this.fetch();var t=this.fetchedData<<1;this.STATUS.setStatus(s.C,(t&65280)>0),this.setZN(t&255),this.isImplicitInvoked?this.A=t&255:this.write(this.absoluteAddress,t&255)}},{key:"BIT",value:function(){this.fetch();var t=this.fetchedData&this.A;this.STATUS.setStatus(s.Z,t===0),this.STATUS.setStatus(s.N,(this.fetchedData&s.N)>0),this.STATUS.setStatus(s.V,(this.fetchedData&s.V)>0)}},{key:"LSR",value:function(){this.fetch(),this.STATUS.setStatus(s.C,(this.fetchedData&1)===1);var t=this.fetchedData>>1&255;this.setZN(t),this.isImplicitInvoked?this.A=t:this.write(this.absoluteAddress,t)}},{key:"ROL",value:function(){this.fetch();var t=this.STATUS.getStatus(s.C)?1:0,i=(this.fetchedData<<1)+t&255;this.STATUS.setStatus(s.C,(this.fetchedData&128)>0),this.setZN(i),this.isImplicitInvoked?this.A=i:this.write(this.absoluteAddress,i)}},{key:"ROR",value:function(){this.fetch();var t=this.STATUS.getStatus(s.C)?1:0,i=(this.fetchedData>>1|t<<7)&255;this.STATUS.setStatus(s.C,(this.fetchedData&1)>0),this.setZN(i),this.isImplicitInvoked?this.A=i:this.write(this.absoluteAddress,i)}},{key:"BRK",value:function(){this.nextPC();var t=this.PC;this.pushStack(t>>8&255),this.pushStack(t&255),this.STATUS.setStatus(s.I,!0),this.STATUS.setStatus(s.B,!0),this.pushStack(this.STATUS.status),this.STATUS.setStatus(s.B,!1);var i=this.read(65534),e=this.read(65535);this.PC=e<<8|i}},{key:"RTI",value:function(){var t=this.popStack(),i=this.popStack(),e=this.popStack();t&=~s.U,t&=~s.B,this.STATUS.status=t,this.PC=e<<8|i}},{key:"CMP",value:function(){this.fetch();var t=this.A-this.fetchedData;this.STATUS.setStatus(s.C,t>=0),this.STATUS.setStatus(s.Z,t===0),this.STATUS.setStatus(s.N,t<0||t>=128),this.clocks+=1}},{key:"CPX",value:function(){this.fetch();var t=this.X-this.fetchedData;this.STATUS.setStatus(s.C,t>=0),this.STATUS.setStatus(s.Z,t===0),this.STATUS.setStatus(s.N,t<0||t>=128),this.clocks+=1}},{key:"CPY",value:function(){this.fetch();var t=this.Y-this.fetchedData;this.STATUS.setStatus(s.C,t>=0),this.STATUS.setStatus(s.Z,t===0),this.STATUS.setStatus(s.N,t<0||t>=128),this.clocks+=1}},{key:"PHA",value:function(){this.pushStack(this.A)}},{key:"PLA",value:function(){this.A=this.popStack(),this.setZN(this.A)}},{key:"PHP",value:function(){var t=this.STATUS.status|s.U|s.B;this.STATUS.setStatus(s.U,!1),this.STATUS.setStatus(s.B,!1),this.pushStack(t)}},{key:"PLP",value:function(){var t=this.popStack();this.STATUS.status=t,this.STATUS.setStatus(s.U,!0)}},{key:"TSX",value:function(){this.X=this.SP,this.setZN(this.X)}},{key:"TXS",value:function(){this.SP=this.X}},{key:"TAX",value:function(){this.X=this.A,this.setZN(this.X)}},{key:"TAY",value:function(){this.Y=this.A,this.setZN(this.Y)}},{key:"TXA",value:function(){this.A=this.X,this.setZN(this.A)}},{key:"TYA",value:function(){this.A=this.Y,this.setZN(this.A)}},{key:"NOP",value:function(){[28,60,92,124,220,252].includes(this.opcode)&&(this.clocks+=1)}}]),a}();export{l as default};
