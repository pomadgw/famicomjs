function h(i,t){if(!(i instanceof t))throw new TypeError("Cannot call a class as a function")}function n(i,t){for(var s=0;s<t.length;s++){var e=t[s];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(i,e.key,e)}}function c(i,t,s){return t&&n(i.prototype,t),s&&n(i,s),i}import o from"./register.js";import u from"./instructions/index.js";var l=function(){function i(t){h(this,i),this.ram=new Uint8Array(t),this.registers=new Proxy({A:new Uint8Array([0]),X:new Uint8Array([0]),Y:new Uint8Array([0]),SP:new Uint8Array([255]),PC:new Uint16Array([0]),STATUS:o.create()},{get:function(s,e){return e==="STATUS"?s[e]:s[e][0]},set:function(s,e,r){return e==="STATUS"?s[e]=r:s[e][0]=r,!0}}),this.fetched=0,this.addresses={absoluteAddress:0,relativeAddress:0},this.isImplicit=!1,this.cycles=0,this.opcode=0,this.bus=null}return c(i,[{key:"connect",value:function(t){this.bus=t}},{key:"reset",value:function(){this.registers.A=0,this.registers.X=0,this.registers.Y=0,this.registers.SP=253,this.registers.STATUS.status=0,this.registers.STATUS.U=!0;var t=65532,s=this.ram[t],e=this.ram[t+1];this.registers.PC=e<<8|s,this.addresses.absoluteAddress=0,this.addresses.relativeAddress=0,this.fetched=0,this.cycles=8}},{key:"interrupt",value:function(t){var s=this.registers.PC;this.pushStack(s>>8&255),this.pushStack(s&255),this.registers.STATUS.B=!1,this.registers.STATUS.U=!0,this.registers.STATUS.I=!0,this.pushStack(+this.registers.STATUS),this.addresses.absoluteAddress=t;var e=this.ram[t],r=this.ram[t+1];this.registers.PC=r<<8|e,this.cycles=7}},{key:"irq",value:function(){this.registers.STATUS.I&&this.interrupt(65534)}},{key:"nmi",value:function(){this.interrupt(65530)}},{key:"clock",value:function(){do this.atomicClock();while(!this.isComplete)}},{key:"atomicClock",value:function(){if(this.isComplete){var t=this.readRAM(this.nextPC());this.opcode=t,this.operation=u[t],this.cycles=this.operation.cycles,this.cycles+=this.fetch(this.operation.addressing(this)),this.cycles+=this.operation.operator(this)}this.cycles-=1}},{key:"fetch",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{clocks:0},s=t.absoluteAddress,e=t.value,r=t.relativeAddress,a=t.clocks;return this.isImplicit=e!=null,this.fetched=e??this.readRAM(s),this.addresses.absoluteAddress=s,this.addresses.relativeAddress=r,a}},{key:"readRAM",value:function(t){return this.ram[t]}},{key:"nextPC",value:function(){return this.registers.PC++}},{key:"pushStack",value:function(t){this.ram[this.registers.SP+256]=t,this.registers.SP--}},{key:"popStack",value:function(){this.registers.SP++;var t=this.ram[this.registers.SP+256];return t}},{key:"isComplete",get:function(){return this.cycles===0}}]),i}();export{l as default};
