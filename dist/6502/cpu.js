function u(r,t){if(!(r instanceof t))throw new TypeError("Cannot call a class as a function")}function a(r,t){for(var e=0;e<t.length;e++){var s=t[e];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(r,s.key,s)}}function l(r,t,e){return t&&a(r.prototype,t),e&&a(r,e),r}import c from"./register.js";import f from"./instructions/index.js";var o=function(){function r(t){u(this,r),this.ram=new Uint8Array(t),this.registers=new Proxy({A:new Uint8Array([0]),X:new Uint8Array([0]),Y:new Uint8Array([0]),SP:new Uint8Array([255]),PC:new Uint16Array([0]),STATUS:c.create()},{get:function(s,i){return i==="STATUS"?s[i]:s[i][0]},set:function(s,i,n){return i==="STATUS"?s[i]=n:s[i][0]=n,!0}}),this.fetched=0,this.addresses={absoluteAddress:0,relativeAddress:0},this.isImplicit=!1,this.cycles=0,this.opcode=0,this.bus=null}return l(r,[{key:"connect",value:function(e){this.bus=e}},{key:"reset",value:function(){this.registers.A=0,this.registers.X=0,this.registers.Y=0,this.registers.SP=253,this.registers.STATUS.status=0,this.registers.STATUS.U=!0;var e=65532,s=this.ram[e],i=this.ram[e+1];this.registers.PC=i<<8|s,this.addresses.absoluteAddress=0,this.addresses.relativeAddress=0,this.fetched=0,this.cycles=8}},{key:"interrupt",value:function(e){var s=this.registers.PC;this.pushStack(s>>8&255),this.pushStack(s&255),this.registers.STATUS.B=!1,this.registers.STATUS.U=!0,this.registers.STATUS.I=!0,this.pushStack(+this.registers.STATUS),this.addresses.absoluteAddress=e;var i=this.ram[e],n=this.ram[e+1];this.registers.PC=n<<8|i,this.cycles=7}},{key:"irq",value:function(){this.registers.STATUS.I&&this.interrupt(65534)}},{key:"nmi",value:function(){this.interrupt(65530)}},{key:"clock",value:function(){do this.atomicClock();while(!this.isComplete)}},{key:"atomicClock",value:function(){if(this.isComplete){var e=this.readRAM(this.nextPC());this.opcode=e,this.operation=f[e],this.cycles=this.operation.cycles,this.cycles+=this.fetch(this.operation.addressing(this)),this.cycles+=this.operation.operator(this)}this.cycles-=1}},{key:"fetch",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{clocks:0},s=e.absoluteAddress,i=e.value,n=e.relativeAddress,h=e.clocks;return this.isImplicit=i!=null,this.fetched=i??this.readRAM(s),this.addresses.absoluteAddress=s,this.addresses.relativeAddress=n,h}},{key:"readRAM",value:function(e){return this.ram[e]}},{key:"nextPC",value:function(){return this.registers.PC++}},{key:"pushStack",value:function(e){this.ram[this.registers.SP+256]=e,this.registers.SP--}},{key:"popStack",value:function(){this.registers.SP++;var e=this.ram[this.registers.SP+256];return e}},{key:"isComplete",get:function(){return this.cycles===0}}]),r}();export{o as default};
