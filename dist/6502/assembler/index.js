function I(e,r){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);r&&(t=t.filter(function(p){return Object.getOwnPropertyDescriptor(e,p).enumerable})),n.push.apply(n,t)}return n}function E(e){for(var r=1;r<arguments.length;r++){var n=arguments[r]!=null?arguments[r]:{};r%2?I(Object(n),!0).forEach(function(t){R(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):I(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function R(e,r,n){return r in e?Object.defineProperty(e,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[r]=n,e}function m(e){return U(e)||q(e)||B(e)||k()}function k(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function q(e){if(typeof Symbol!="undefined"&&Symbol.iterator in Object(e))return Array.from(e)}function U(e){if(Array.isArray(e))return C(e)}function $(e,r){return G(e)||F(e,r)||B(e,r)||z()}function z(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function B(e,r){if(!e)return;if(typeof e=="string")return C(e,r);var n=Object.prototype.toString.call(e).slice(8,-1);if(n==="Object"&&e.constructor&&(n=e.constructor.name),n==="Map"||n==="Set")return Array.from(e);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return C(e,r)}function C(e,r){(r==null||r>e.length)&&(r=e.length);for(var n=0,t=new Array(r);n<r;n++)t[n]=e[n];return t}function F(e,r){if(typeof Symbol=="undefined"||!(Symbol.iterator in Object(e)))return;var n=[],t=!0,p=!1,l=void 0;try{for(var c=e[Symbol.iterator](),u;!(t=(u=c.next()).done)&&!(n.push(u.value),r&&n.length===r);t=!0);}catch(y){p=!0,l=y}finally{try{!t&&c.return!=null&&c.return()}finally{if(p)throw l}}return n}function G(e){if(Array.isArray(e))return e}import H from"../instructions/index.js";import J from"./parser.js";var M=["bcc","bcs","beq","bne","bmi","bpl","bvs","bvc"];function K(e){var r,n=e.opcode,t=e.params,p=e.label,l=e.startBinary,c=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},u=(r=t==null?void 0:t.mode)!==null&&r!==void 0?r:"IMP",y=[];if(M.includes(n.toLowerCase())&&(u="REL"),!(t==null?void 0:t.mode)&&["jmp","jsr"].includes(n.toLowerCase())&&(u="ABS"),(t==null?void 0:t.label)&&c[t.label]){var h;u=(h=t==null?void 0:t.mode)!==null&&h!==void 0?h:c[t.label].mode,y=c[t.label].value}(t==null?void 0:t.offsetRegister)&&(u="".concat(u.slice(0,2)).concat(t.offsetRegister));var w=Object.entries(H).find(function(j){var A=$(j,2),g=A[1];return g.name.toLowerCase()===n.toLowerCase()&&g.addressingName===u}),b;u==="IMP"?b=[Number(w[0])]:b=[Number(w[0])].concat(m((t==null?void 0:t.value)?t.value:y));var o=b.length;return!(t==null?void 0:t.mode)&&["jmp","jsr"].includes(n.toLowerCase())?o+=2:M.includes(n.toLowerCase())&&(o+=1),E(E({result:b,length:o,label:p,opcode:n,addressingMode:u},(t==null?void 0:t.label)?{labelTarget:t.label}:{}),l?{startBinary:l}:{})}function V(e,r){return r<<8|e}export default function W(e){for(var r=J.parse(e.trim().replace(/(;|\/\/).+/g,"")),n=[],t=[],p={},l=0,c=null,u=null,y={address:65532},h={address:65530},w={address:65534},b=[];l<r.length;){var o=r[l];if(o.data)t.push(o),r.splice(l,1);else if(o.varName)p[o.varName]=o.value,r.splice(l,1);else if(o.reset)y.data=o.reset,r.splice(l,1);else if(o.nmi)h.data=o.nmi,r.splice(l,1);else if(o.irq)w.data=o.irq,r.splice(l,1);else if(o.pc)c=V.apply(void 0,m(o.pc)),u=c,r.splice(l,1);else if(o.label){var j;n.push(E(E({},o),{},{offset:l,pc:(j=u)!==null&&j!==void 0?j:0})),r.splice(l,1)}else c!==null&&(o.startBinary=c,b.push(l),c=null),n.length>0&&(o.label=n.pop()),l++}var A=r.map(function(a){return K(a,p)}),g=[];b.length===0&&b.push(0),b.forEach(function(a,i,f){var s,d=(s=f==null?void 0:f[i+1])!==null&&s!==void 0?s:A.length;g.push(A.slice(a,d))});var N=function(a){a.reduce(function(i,f,s,d){var O=i+d[s].length;return d[s].totalLength=O,d[s].pos=i,O},0),a.filter(function(i){return i.labelTarget}).forEach(function(i){var f=a.find(function(D){var S;return((S=D.label)===null||S===void 0?void 0:S.label)===i.labelTarget});if(f)if(i.addressingMode==="ABS"){var s=f.label.pc+f.pos,d=s&255,O=s>>8&255;i.result.push(d),i.result.push(O)}else{var x=f.totalLength-i.totalLength-f.length;i.result.push(x&255)}})};g.map(N);for(var v=m(Array(65536).keys()).map(function(){return 0}),P=0;P<65536;P++){var L;v[P]=(L=v[P])!==null&&L!==void 0?L:0}return g.forEach(function(a){var i,f=(i=a[0].startBinary)!==null&&i!==void 0?i:0,s=a.map(function(d){return d.result}).reduce(function(d,O){return[].concat(m(d),m(O))},[]);v.splice.apply(v,[f,s.length].concat(m(s)))}),t.forEach(function(a){v.splice.apply(v,[a.address,a.data.length].concat(m(a.data)))}),[y,h,w].forEach(function(a){a.data&&v.splice.apply(v,[a.address,2].concat(m(a.data)))}),v}
