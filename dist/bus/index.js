function o(i,t){if(!(i instanceof t))throw new TypeError("Cannot call a class as a function")}function s(i,t){for(var e=0;e<t.length;e++){var r=t[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(i,r.key,r)}}function u(i,t,e){return t&&s(i.prototype,t),e&&s(i,e),i}import a from"../controllers/index.js";var c=function(){function i(t,e,r){o(this,i),this.cpu=t,this.ppu=e,this.cpu.connect(this),this.ram=new Uint8Array(8192),this.globalSystemClockNumber=0,this._on={render:r},this.controllers=[new a({KeyA:"A",KeyS:"B",KeyZ:"Select",KeyX:"Start",ArrowUp:"Up",ArrowDown:"Down",ArrowLeft:"Left",ArrowRight:"Right"}),new a()],this.isReadOnly=!1,this.cartridge=null}return u(i,[{key:"cpuRead",value:function(t){var e,r=(e=this.cartridge)===null||e===void 0?void 0:e.cpuRead(t);return r!==null?r:t<8192?this.ram[t&2047]:t<16384?this.ppu.cpuRead(t&7,this.isReadOnly):t===16406||t===16407?this.controllers[t&1].read():0}},{key:"cpuWrite",value:function(t,e){var r;if((r=this.cartridge)===null||r===void 0?void 0:r.cpuWrite(t,e))return!0;t<8192?this.ram[t&2047]=e:t<16384?this.ppu.cpuWrite(t&7,e):(t===16406||t===16407)&&this.controllers[t&1].write(e)}},{key:"getRAMSnapshot",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:32768,e=new Uint8Array(65536),r=this.isReadOnly;this.isReadOnly=!0;for(var n=t;n<65536;n++)e[n]=this.cpuRead(n);return this.isReadOnly=r,e}},{key:"insertCartridge",value:function(t){this.cartridge=t,this.ppu.insertCartridge(t)}},{key:"reset",value:function(){this.cpu.reset(),this.ppu.reset(),this.globalSystemClockNumber=0}},{key:"clock",value:function(){this.globalSystemClockNumber%3===0&&this.cpu.clock(),this.ppu.clock(),this.ppu.nmi&&(this.ppu.nmi=!1,this.cpu.nmi()),this.globalSystemClockNumber+=1,this.ppu.isFrameComplete&&this._on.render&&this._on.render(this.ppu.getScreen().imageData)}}]),i}();export{c as default};
